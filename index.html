<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Space Jet Shooter</title>
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no" />
<style>
  :root { --accent:#00c3ff; --bg:#000; }
  html,body{height:100%;margin:0;background:radial-gradient(circle at 20% 10%, #021 0%, #000 60%);font-family:Arial,Helvetica,sans-serif;color:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;touch-action:none;}
  #frame{width:100%;max-width:520px;padding:12px;border-radius:10px;border:4px solid rgba(0,195,255,0.12);box-shadow:0 10px 40px rgba(0,0,0,0.7);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
  canvas{width:100%;max-width:500px;height:600px;display:block;border-radius:6px;background:transparent;touch-action:none;}
  #overlay{position:relative;width:100%;max-width:500px;height:600px;margin:0 auto;}
  .panel{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:30;}
  .card{width:90%;max-width:420px;background:rgba(0,0,0,0.9);border-radius:8px;padding:18px;text-align:center;border:1px solid rgba(255,255,255,0.04);}
  button{background:var(--accent);border:none;color:#001;padding:10px 16px;border-radius:8px;font-size:16px;cursor:pointer;margin:6px;}
  button:hover{background:#008bb5}
  #hud{position:absolute;top:10px;left:0;width:100%;max-width:500px;display:flex;justify-content:space-between;align-items:center;padding:0 10px;box-sizing:border-box;z-index:10;}
  .info{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;font-size:14px;backdrop-filter:blur(2px);}
  #livesContainer { display: flex; gap: 5px; align-items: center; }
  .life-icon { 
    width: 18px;
    height: 18px;
    background-color: #ff3366;
    clip-path: path('M10,6 Q10,0 15,0 T20,6 Q20,10 15,14 Q10,10 10,6');
    filter: drop-shadow(0 0 2px #ff0066);
  }
  #loadingText{opacity:0.95;margin-top:12px;font-size:14px}
  #levelInfo { font-size: 13px; opacity: 0.8; }
  
  /* Mobile controls */
  #controls {
    display: none;
    position: absolute;
    bottom: 20px;
    width: 100%;
    justify-content: space-between;
    padding: 0 20px;
    box-sizing: border-box;
    z-index: 20;
  }
  
  .mobile-btn {
    width: 60px;
    height: 60px;
    background: rgba(0, 195, 255, 0.2);
    border: 2px solid rgba(0, 195, 255, 0.5);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  
  .mobile-btn:active {
    background: rgba(0, 195, 255, 0.4);
  }
  
  @media (max-width: 600px) {
    #controls {
      display: flex;
    }
    
    #hud {
      flex-direction: row;
      align-items: center;
      gap: 6px;
      top: 5px;
    }
    
    .info {
      padding: 6px 10px;
      font-size: 13px;
    }
    
    #levelInfo {
      display: none;
    }
  }
</style>
</head>
<body>
  <div id="frame">
    <div id="overlay">
      <canvas id="game" width="500" height="600"></canvas>

      <div id="loadingPanel" class="panel">
        <div class="card">
          <h2 style="color:var(--accent);margin:6px 0;">Loading assets‚Ä¶</h2>
          <div id="loadingText">Preparing game ‚Äî please wait</div>
        </div>
      </div>

      <div id="startPanel" class="panel" style="display:none;">
        <div class="card">
          <h2 style="color:var(--accent);margin:6px 0;">üöÄ Space Jet Shooter</h2>
          <p style="margin:6px 0;">Arrow ‚Üê ‚Üí to move ‚Ä¢ Auto-fire on mobile<br/>3 lives ‚Ä¢ Enemies shoot back</p>
          <div>
            <button id="startBtn">Start Game</button>
            <button id="soundToggle" style="background:rgba(255,255,255,0.1);color:white;">üîä Sound On</button>
          </div>
        </div>
      </div>
      
      <div id="hud">
        <div class="info" id="scoreBox">0</div>
        <div class="info" id="livesBox">
          <div id="livesContainer"></div>
        </div>
        <div id="levelInfo">Level: 1 (Easy)</div>
      </div>
      
      <!-- Mobile controls -->
      <div id="controls">
        <div class="mobile-btn" id="leftBtn">‚Üê</div>
        <div class="mobile-btn" id="rightBtn">‚Üí</div>
      </div>
    </div>
  </div>

<script>
// Game Constants
const W = 500, H = 600;
const PLAYER_SPEED = 7;
const BULLET_SPEED = 12;
const MAX_LIVES = 3;
const LEVEL_THRESHOLDS = [500, 1000, 1500, 2000];

// Game Elements
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const loadingPanel = document.getElementById('loadingPanel');
const startPanel = document.getElementById('startPanel');
const startBtn = document.getElementById('startBtn');
const soundToggle = document.getElementById('soundToggle');
const scoreBox = document.getElementById('scoreBox');
const livesContainer = document.getElementById('livesContainer');
const levelInfo = document.getElementById('levelInfo');

// Mobile controls
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');

// Sound effects
const sounds = {
  shoot: new Audio(),
  enemyShoot: new Audio(),
  explosionSmall: new Audio(),
  explosionLarge: new Audio(),
  playerHit: new Audio(),
  gameOver: new Audio(),
  levelUp: new Audio(),
  background: new Audio()
};

// Initialize sounds with data URIs (base64 encoded short audio clips)
function initSounds() {
  // Player shoot sound - laser blast
  sounds.shoot.src = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...'; // Shortened for brevity
  sounds.shoot.volume = 0.3;
  
  // Enemy shoot sound - different laser
  sounds.enemyShoot.src = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...';
  sounds.enemyShoot.volume = 0.2;
  
  // Small explosion
  sounds.explosionSmall.src = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...';
  sounds.explosionSmall.volume = 0.4;
  
  // Large explosion (for boss)
  sounds.explosionLarge.src = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...';
  sounds.explosionLarge.volume = 0.5;
  
  // Player hit sound
  sounds.playerHit.src = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...';
  sounds.playerHit.volume = 0.6;
  
  // Game over sound
  sounds.gameOver.src = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...';
  sounds.gameOver.volume = 0.7;
  
  // Level up sound
  sounds.levelUp.src = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...';
  sounds.levelUp.volume = 0.5;
  
  // Background music loop
  sounds.background.src = 'data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV';
  sounds.background.loop = true;
  sounds.background.volume = 0.3;
}

// Sound state
let soundEnabled = true;

// Game State
let keys = {};
let touchControls = {
  left: false,
  right: false
};
let player = {
  x: W/2 - 25,
  y: H - 90,
  w: 50,
  h: 50,
  speed: PLAYER_SPEED,
  lives: MAX_LIVES
};
let bullets = [];
let enemies = [];
let enemyBullets = [];
let explosions = [];
let stars = [];
let score = 0;
let shootCooldown = 0;
let running = false;
let gameOver = false;
let level = 1;
let enemySpawnRate = 0.01;
let enemySpeed = 1.5;
let enemyShootInterval = 120;
let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
let autoFire = isMobile;

// Enhanced player spaceship design
const playerSVG = `data:image/svg+xml;charset=utf-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 50'>
  <defs>
    <linearGradient id="shipGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="%2300c3ff"/>
      <stop offset="100%" stop-color="%23007acc"/>
    </linearGradient>
    <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
      <feGaussianBlur stdDeviation="2" result="blur"/>
      <feComposite in="SourceGraphic" in2="blur" operator="over"/>
    </filter>
  </defs>
  <path d='M25 5 L35 20 L45 22 L35 25 L25 45 L15 25 L5 22 L15 20 Z' fill='url(%23shipGrad)' stroke='%2300a2e0' stroke-width='1' filter='url(%23glow)'/>
  <ellipse cx='25' cy='20' rx='8' ry='5' fill='rgba(0,10,20,0.8)'/>
  <rect x='22' y='15' width='6' height='2' fill='%2300a2e0' rx='1'/>
  <circle cx='25' cy='20' r='2' fill='%2300e0ff' filter='url(%23glow)'/>
</svg>`;

// Enhanced enemy designs (3 types)
const enemySVGs = [
  // Type 1 - Alien Fighter (more detailed)
  `data:image/svg+xml;charset=utf-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'>
    <defs>
      <filter id="alienGlow">
        <feGaussianBlur stdDeviation="1.5" result="blur"/>
        <feComposite in="SourceGraphic" in2="blur" operator="over"/>
      </filter>
    </defs>
    <path d='M20 5 L25 15 L35 18 L25 20 L20 35 L15 20 L5 18 L15 15 Z' fill='%23ff3366' stroke='%23cc0000' stroke-width='1' filter='url(%23alienGlow)'/>
    <circle cx='20' cy='15' r='5' fill='rgba(50,0,0,0.7)'/>
    <circle cx='18' cy='13' r='1.5' fill='%23ff9999'/>
    <circle cx='22' cy='13' r='1.5' fill='%23ff9999'/>
    <path d='M18 17 Q20 19 22 17' stroke='%23ff9999' fill='none' stroke-width='1'/>
  </svg>`,
  
  // Type 2 - Advanced Saucer
  `data:image/svg+xml;charset=utf-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'>
    <defs>
      <filter id="saucerGlow">
        <feGaussianBlur stdDeviation="1.5" result="blur"/>
        <feComposite in="SourceGraphic" in2="blur" operator="over"/>
      </filter>
      <radialGradient id="saucerGrad" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
        <stop offset="0%" stop-color="%23b76bff"/>
        <stop offset="100%" stop-color="%238f4ed1"/>
      </radialGradient>
    </defs>
    <ellipse cx='20' cy='15' rx='15' ry='8' fill='url(%23saucerGrad)' stroke='%238f4ed1' stroke-width='1' filter='url(%23saucerGlow)'/>
    <ellipse cx='20' cy='15' rx='10' ry='4' fill='rgba(20,0,40,0.7)'/>
    <circle cx='20' cy='15' r='3' fill='%23d9b3ff'/>
    <rect x='12' y='25' width='4' height='2' fill='%23d9b3ff'/>
    <rect x='24' y='25' width='4' height='2' fill='%23d9b3ff'/>
    <circle cx='14' cy='12' r='1' fill='%23d9b3ff'/>
    <circle cx='26' cy='12' r='1' fill='%23d9b3ff'/>
  </svg>`,
  
  // Type 3 - Boss Ship
  `data:image/svg+xml;charset=utf-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 30'>
    <defs>
      <filter id="bossGlow">
        <feGaussianBlur stdDeviation="1.5" result="blur"/>
        <feComposite in="SourceGraphic" in2="blur" operator="over"/>
      </filter>
      <linearGradient id="bossGrad" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stop-color="%23ffaa33"/>
        <stop offset="50%" stop-color="%23ff7700"/>
        <stop offset="100%" stop-color="%23ffaa33"/>
      </linearGradient>
    </defs>
    <path d='M5 15 L15 5 L45 10 L35 20 L45 25 L15 25 Z' fill='url(%23bossGrad)' stroke='%23cc7700' stroke-width='1' filter='url(%23bossGlow)'/>
    <rect x='25' y='12' width='15' height='6' fill='rgba(50,30,0,0.7)'/>
    <circle cx='30' cy='15' r='2' fill='%23ffcc00'/>
    <circle cx='35' cy='15' r='2' fill='%23ffcc00'/>
    <rect x='10' y='10' width='5' height='2' fill='%23ffcc00' rx='1'/>
    <rect x='10' y='18' width='5' height='2' fill='%23ffcc00' rx='1'/>
  </svg>`
];

// Load images
const playerImg = new Image();
playerImg.src = playerSVG;

const enemyImgs = enemySVGs.map(svg => {
  const img = new Image();
  img.src = svg;
  return img;
});

// Initialize game
function init() {
  initSounds();
  createStars();
  resetGame();
  
  // Set up event listeners
  document.addEventListener('keydown', e => keys[e.code] = true);
  document.addEventListener('keyup', e => keys[e.code] = false);
  
  // Touch controls
  leftBtn.addEventListener('touchstart', () => touchControls.left = true);
  leftBtn.addEventListener('touchend', () => touchControls.left = false);
  leftBtn.addEventListener('touchcancel', () => touchControls.left = false);
  
  rightBtn.addEventListener('touchstart', () => touchControls.right = true);
  rightBtn.addEventListener('touchend', () => touchControls.right = false);
  rightBtn.addEventListener('touchcancel', () => touchControls.right = false);
  
  // Prevent scrolling when touching the game controls
  document.addEventListener('touchmove', (e) => {
    if (running) e.preventDefault();
  }, { passive: false });
  
  startBtn.addEventListener('click', startGame);
  soundToggle.addEventListener('click', toggleSound);
  
  // Start game loop
  requestAnimationFrame(gameLoop);
  
  // Hide loading screen after images load
  Promise.all([
    new Promise(resolve => playerImg.onload = playerImg.onerror = resolve),
    ...enemyImgs.map(img => new Promise(resolve => img.onload = img.onerror = resolve))
  ]).then(() => {
    loadingPanel.style.display = 'none';
    startPanel.style.display = 'flex';
  });
}

// Toggle sound on/off
function toggleSound() {
  soundEnabled = !soundEnabled;
  soundToggle.textContent = soundEnabled ? 'üîä Sound On' : 'üîá Sound Off';
  sounds.background.muted = !soundEnabled;
}

// Play sound effect if enabled
function playSound(sound) {
  if (soundEnabled && sounds[sound]) {
    sounds[sound].currentTime = 0;
    sounds[sound].play().catch(e => console.log('Sound play failed:', e));
  }
}

// Update difficulty based on score
function updateDifficulty() {
  const newLevel = LEVEL_THRESHOLDS.findIndex(threshold => score < threshold) + 1;
  if (newLevel !== level) {
    level = newLevel;
    levelInfo.textContent = `Level: ${level} (${getDifficultyName(level)})`;
    playSound('levelUp');
    
    // Adjust game parameters based on level
    enemySpawnRate = 0.01 + (level * 0.005);
    enemySpeed = 1.5 + (level * 0.3);
    enemyShootInterval = Math.max(30, 120 - (level * 15));
  }
}

function getDifficultyName(level) {
  const names = ['Easy', 'Medium', 'Hard', 'Expert', 'Insane'];
  return names[Math.min(level - 1, names.length - 1)];
}

// Create visual life indicators (hearts)
function updateLivesDisplay() {
  livesContainer.innerHTML = '';
  for (let i = 0; i < player.lives; i++) {
    const lifeIcon = document.createElement('div');
    lifeIcon.className = 'life-icon';
    if (player.lives === 1) {
      lifeIcon.style.backgroundColor = '#ff0066'; // More intense red when last life
      lifeIcon.style.filter = 'drop-shadow(0 0 4px #ff0066)';
    }
    livesContainer.appendChild(lifeIcon);
  }
}

// Create stars for background
function createStars() {
  stars = [];
  for (let i = 0; i < 150; i++) {
    stars.push({
      x: Math.random() * W,
      y: Math.random() * H,
      r: Math.random() * 1.2 + 0.3,
      speed: Math.random() * 0.5 + 0.2,
      alpha: Math.random() * 0.7 + 0.3
    });
  }
}

// Reset game state
function resetGame() {
  player = {
    x: W/2 - 25,
    y: H - 90,
    w: 50,
    h: 50,
    speed: PLAYER_SPEED,
    lives: MAX_LIVES
  };
  bullets = [];
  enemies = [];
  enemyBullets = [];
  explosions = [];
  score = 0;
  shootCooldown = 0;
  gameOver = false;
  level = 1;
  enemySpawnRate = 0.01;
  enemySpeed = 1.5;
  enemyShootInterval = 120;
  
  scoreBox.textContent = '0';
  levelInfo.textContent = 'Level: 1 (Easy)';
  updateLivesDisplay();
}

// Start game
function startGame() {
  startPanel.style.display = 'none';
  resetGame();
  running = true;
  if (soundEnabled) {
    sounds.background.currentTime = 0;
    sounds.background.play().catch(e => console.log('Background music play failed:', e));
  }
}

// Main game loop
function gameLoop() {
  update();
  render();
  requestAnimationFrame(gameLoop);
}

// Update game state
function update() {
  if (!running || gameOver) return;
  
  updateDifficulty();

  // Move player
  if (keys['ArrowLeft'] || touchControls.left) player.x -= player.speed;
  if (keys['ArrowRight'] || touchControls.right) player.x += player.speed;
  player.x = Math.max(0, Math.min(W - player.w, player.x));

  // Player shooting
  if (autoFire || keys['Space']) {
    if (shootCooldown <= 0) {
      bullets.push({
        x: player.x + player.w/2 - 3,
        y: player.y - 10,
        w: 6,
        h: 15,
        speed: BULLET_SPEED
      });
      playSound('shoot');
      shootCooldown = isMobile ? 20 : 10;
    }
  }
  if (shootCooldown > 0) shootCooldown--;

  // Move bullets
  for (let i = bullets.length - 1; i >= 0; i--) {
    bullets[i].y -= bullets[i].speed;
    if (bullets[i].y + bullets[i].h < 0) bullets.splice(i, 1);
  }

  // Spawn enemies
  if (Math.random() < enemySpawnRate) {
    const type = Math.floor(Math.random() * enemyImgs.length);
    const size = type === 2 ? 40 : 30;
    enemies.push({
      x: Math.random() * (W - size),
      y: -size,
      w: size,
      h: size,
      speed: Math.random() * 0.5 + enemySpeed,
      shootTimer: Math.floor(Math.random() * enemyShootInterval),
      type: type
    });
  }

  // Update enemies
  for (let i = enemies.length - 1; i >= 0; i--) {
    const enemy = enemies[i];
    enemy.y += enemy.speed;
    
    // Enemy shooting logic
    enemy.shootTimer--;
    if (enemy.shootTimer <= 0 && enemy.y > 0) {
      enemyBullets.push({
        x: enemy.x + enemy.w/2 - 3,
        y: enemy.y + enemy.h,
        w: 6,
        h: 15,
        speed: BULLET_SPEED * 0.6
      });
      playSound('enemyShoot');
      enemy.shootTimer = enemyShootInterval;
    }
    
    if (enemy.y > H) enemies.splice(i, 1);
  }

  // Move enemy bullets
  for (let i = enemyBullets.length - 1; i >= 0; i--) {
    enemyBullets[i].y += enemyBullets[i].speed;
    if (enemyBullets[i].y > H) enemyBullets.splice(i, 1);
  }

  // Check collisions
  checkCollisions();
  
  // Move stars
  for (let star of stars) {
    star.y += star.speed;
    if (star.y > H) {
      star.y = 0;
      star.x = Math.random() * W;
    }
  }
}

// Check collisions
function checkCollisions() {
  // Bullets hitting enemies
  for (let i = enemies.length - 1; i >= 0; i--) {
    const enemy = enemies[i];
    for (let j = bullets.length - 1; j >= 0; j--) {
      const bullet = bullets[j];
      if (isColliding(bullet, enemy)) {
        explosions.push({
          x: enemy.x + enemy.w/2,
          y: enemy.y + enemy.h/2,
          r: 0,
          maxR: enemy.type === 2 ? 30 : 25,
          color: enemy.type === 0 ? '#ff3366' : enemy.type === 1 ? '#b76bff' : '#ffaa33'
        });
        
        // Play appropriate explosion sound
        if (enemy.type === 2) {
          playSound('explosionLarge');
        } else {
          playSound('explosionSmall');
        }
        
        enemies.splice(i, 1);
        bullets.splice(j, 1);
        score += (enemy.type + 1) * 10;
        scoreBox.textContent = score;
        break;
      }
    }
  }

  // Enemy bullets hitting player
  for (let i = enemyBullets.length - 1; i >= 0; i--) {
    const bullet = enemyBullets[i];
    if (isColliding(bullet, player)) {
      explosions.push({
        x: player.x + player.w/2,
        y: player.y + player.h/2,
        r: 0,
        maxR: 30,
        color: '#ff3366'
      });
      playSound('playerHit');
      enemyBullets.splice(i, 1);
      player.lives--;
      updateLivesDisplay();
      
      if (player.lives <= 0) {
        gameOver = true;
        running = false;
        playSound('gameOver');
        sounds.background.pause();
        setTimeout(() => {
          startPanel.style.display = 'flex';
          startPanel.querySelector('h2').textContent = 'GAME OVER';
          startPanel.querySelector('p').innerHTML = 'Score: <strong>' + score + '</strong><br>Level: <strong>' + level + '</strong>';
          startBtn.textContent = 'Play Again';
        }, 1000);
      }
    }
  }
}

// Collision detection
function isColliding(a, b) {
  return a.x < b.x + b.w &&
         a.x + a.w > b.x &&
         a.y < b.y + b.h &&
         a.y + a.h > b.y;
}

// Render game
function render() {
  // Clear canvas with fading effect
  ctx.fillStyle = 'rgba(0, 0, 20, 0.15)';
  ctx.fillRect(0, 0, W, H);

  // Draw stars
  ctx.fillStyle = 'white';
  for (let star of stars) {
    ctx.globalAlpha = star.alpha;
    ctx.fillRect(star.x, star.y, star.r, star.r);
  }
  ctx.globalAlpha = 1;

  // Draw player
  if (playerImg.complete) {
    ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
  } else {
    drawPlayer(player.x, player.y, player.w, player.h);
  }

  // Draw enemies
  for (let enemy of enemies) {
    if (enemyImgs[enemy.type].complete) {
      ctx.drawImage(enemyImgs[enemy.type], enemy.x, enemy.y, enemy.w, enemy.h);
    } else {
      drawEnemy(enemy.x, enemy.y, enemy.w, enemy.h, enemy.type);
    }
  }

  // Draw bullets
  ctx.fillStyle = '#00c3ff';
  for (let bullet of bullets) {
    ctx.beginPath();
    ctx.roundRect(bullet.x, bullet.y, bullet.w, bullet.h, 2);
    ctx.fill();
  }

  // Draw enemy bullets
  ctx.fillStyle = '#ff3366';
  for (let bullet of enemyBullets) {
    ctx.beginPath();
    ctx.roundRect(bullet.x, bullet.y, bullet.w, bullet.h, 2);
    ctx.fill();
  }

  // Draw explosions
  for (let explosion of explosions) {
    const gradient = ctx.createRadialGradient(
      explosion.x, explosion.y, 0,
      explosion.x, explosion.y, explosion.r
    );
    gradient.addColorStop(0, explosion.color || `rgba(255, 200, 80, ${1 - explosion.r/explosion.maxR})`);
    gradient.addColorStop(0.5, explosion.color ? `rgba(255, 90, 40, ${0.7 - explosion.r/explosion.maxR})` : `rgba(255, 90, 40, ${0.7 - explosion.r/explosion.maxR})`);
    gradient.addColorStop(1, 'rgba(20, 0, 0, 0)');
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(explosion.x, explosion.y, explosion.r, 0, Math.PI*2);
    ctx.fill();
  }

  // Remove finished explosions
  for (let i = explosions.length - 1; i >= 0; i--) {
    explosions[i].r += 1.5;
    if (explosions[i].r > explosions[i].maxR) {
      explosions.splice(i, 1);
    }
  }
}

// Fallback drawing functions
function drawPlayer(x, y, w, h) {
  ctx.fillStyle = '#00c3ff';
  ctx.beginPath();
  ctx.moveTo(x + w/2, y);
  ctx.lineTo(x + w*0.7, y + h*0.4);
  ctx.lineTo(x + w, y + h*0.45);
  ctx.lineTo(x + w*0.7, y + h*0.55);
  ctx.lineTo(x + w/2, y + h);
  ctx.lineTo(x + w*0.3, y + h*0.55);
  ctx.lineTo(x, y + h*0.45);
  ctx.lineTo(x + w*0.3, y + h*0.4);
  ctx.closePath();
  ctx.fill();
  
  // Cockpit
  ctx.fillStyle = 'rgba(0, 20, 40, 0.8)';
  ctx.beginPath();
  ctx.ellipse(x + w/2, y + h*0.35, w*0.2, h*0.15, 0, 0, Math.PI*2);
  ctx.fill();
  
  // Glowing center
  ctx.fillStyle = '#00e0ff';
  ctx.beginPath();
  ctx.arc(x + w/2, y + h*0.35, 4, 0, Math.PI*2);
  ctx.fill();
}

function drawEnemy(x, y, w, h, type) {
  if (type === 0) { // Alien Fighter
    ctx.fillStyle = '#ff3366';
    ctx.beginPath();
    ctx.moveTo(x + w/2, y);
    ctx.lineTo(x + w*0.7, y + h*0.5);
    ctx.lineTo(x + w, y + h*0.6);
    ctx.lineTo(x + w*0.7, y + h);
    ctx.lineTo(x + w/2, y + h*0.8);
    ctx.lineTo(x + w*0.3, y + h);
    ctx.lineTo(x, y + h*0.6);
    ctx.lineTo(x + w*0.3, y + h*0.5);
    ctx.closePath();
    ctx.fill();
    
    // Eyes
    ctx.fillStyle = '#ff9999';
    ctx.beginPath();
    ctx.arc(x + w*0.4, y + h*0.3, 3, 0, Math.PI*2);
    ctx.arc(x + w*0.6, y + h*0.3, 3, 0, Math.PI*2);
    ctx.fill();
    
    // Mouth
    ctx.strokeStyle = '#ff9999';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.arc(x + w/2, y + h*0.4, 2, 0, Math.PI);
    ctx.stroke();
  } 
  else if (type === 1) { // Saucer
    ctx.fillStyle = '#b76bff';
    ctx.beginPath();
    ctx.ellipse(x + w/2, y + h*0.4, w*0.4, h*0.2, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = 'rgba(30, 0, 50, 0.7)';
    ctx.beginPath();
    ctx.ellipse(x + w/2, y + h*0.4, w*0.3, h*0.15, 0, 0, Math.PI*2);
    ctx.fill();
    
    // Lights
    ctx.fillStyle = '#d9b3ff';
    ctx.beginPath();
    ctx.arc(x + w*0.3, y + h*0.3, 2, 0, Math.PI*2);
    ctx.arc(x + w*0.7, y + h*0.3, 2, 0, Math.PI*2);
    ctx.fill();
  }
  else { // Boss Ship
    ctx.fillStyle = '#ffaa33';
    ctx.beginPath();
    ctx.moveTo(x + w*0.1, y + h*0.5);
    ctx.lineTo(x + w*0.3, y);
    ctx.lineTo(x + w*0.9, y + h*0.2);
    ctx.lineTo(x + w*0.7, y + h*0.7);
    ctx.lineTo(x + w*0.9, y + h);
    ctx.lineTo(x + w*0.3, y + h*0.8);
    ctx.closePath();
    ctx.fill();
    
    // Engine glow
    ctx.fillStyle = '#ffcc00';
    ctx.beginPath();
    ctx.arc(x + w*0.2, y + h*0.5, 4, 0, Math.PI*2);
    ctx.arc(x + w*0.8, y + h*0.5, 4, 0, Math.PI*2);
    ctx.fill();
  }
}

// Start the game
init();
</script>
</body>
</html>
